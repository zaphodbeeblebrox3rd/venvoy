# Multi-architecture venvoy environment image for Python 3.9
FROM python:3.9-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    wget \
    vim \
    && rm -rf /var/lib/apt/lists/*

# Install mambaforge with explicit architecture handling
RUN ARCH=$(dpkg --print-architecture) && \
    case "$ARCH" in \
        amd64) CONDA_ARCH="x86_64" ;; \
        arm64) CONDA_ARCH="aarch64" ;; \
        *) CONDA_ARCH="x86_64" ;; \
    esac && \
    wget "https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-${CONDA_ARCH}.sh" -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh && \
    /opt/conda/bin/conda install -n base -c conda-forge mamba -y

# Add conda to PATH
ENV PATH="/opt/conda/bin:$PATH"

# Initialize conda
RUN conda init bash

# Create environment using mamba
RUN mamba create -n venvoy python=3.9 -c conda-forge -y

# Install uv for ultra-fast Python package management
RUN /opt/conda/envs/venvoy/bin/pip install --no-cache-dir uv

# Activate environment by default
ENV CONDA_DEFAULT_ENV=venvoy
ENV CONDA_PREFIX=/opt/conda/envs/venvoy
ENV PATH="/opt/conda/envs/venvoy/bin:$PATH"

# Install common AI/ML packages using mamba
RUN mamba install -n venvoy -c conda-forge \
    numpy \
    pandas \
    matplotlib \
    seaborn \
    jupyter \
    ipython \
    requests \
    python-dotenv \
    -y

# Set working directory
WORKDIR /workspace

# Create user with same UID as host user (for file permissions)
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN groupadd -g $GROUP_ID venvoy && \
    useradd -u $USER_ID -g $GROUP_ID -m -s /bin/bash venvoy

# Switch to user
USER venvoy

# Set up shell with better interactive experience
RUN echo 'conda activate venvoy' >> ~/.bashrc && \
    echo 'export PS1="(🤖 venvoy) \\u@\\h:\\w\\$ "' >> ~/.bashrc && \
    echo 'echo "🚀 Welcome to your AI-ready venvoy environment!"' >> ~/.bashrc && \
    echo 'echo "🐍 Python $(python --version) with AI/ML packages"' >> ~/.bashrc && \
    echo 'echo "📦 Package managers: mamba (fast conda), uv (ultra-fast pip), pip"' >> ~/.bashrc && \
    echo 'echo "📊 Pre-installed: numpy, pandas, matplotlib, jupyter, and more"' >> ~/.bashrc && \
    echo 'echo "🔍 Auto-saving environment.yml on package changes"' >> ~/.bashrc && \
    echo 'echo "📂 Workspace: $(pwd)"' >> ~/.bashrc && \
    echo 'echo "💡 Home directory mounted at: /home/venvoy/host-home"' >> ~/.bashrc

# Default command
CMD ["/bin/bash"]
