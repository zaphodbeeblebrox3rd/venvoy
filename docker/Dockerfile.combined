# venvoy Combined Image - Python and R environment
# This image includes both Python and R in specific version pairs
# Usage: docker run --rm -it zaphodbeeblebrox3rd/venvoy:python3.13-r4.5
#
# Caching Strategy:
# This Dockerfile uses BuildKit cache mounts (--mount=type=cache) to speed up rebuilds:
# - APT package cache: /var/cache/apt and /var/lib/apt (system packages, R)
# - Python package cache: /root/.cache/pip and /root/.cache/uv (Python packages)
# These caches persist between builds, significantly reducing download times.
# Requires BuildKit enabled (DOCKER_BUILDKIT=1) or Podman 4.0+

ARG PYTHON_VERSION=3.11
ARG R_VERSION=4.4
FROM python:${PYTHON_VERSION}-slim

# Set labels for the image
LABEL org.opencontainers.image.title="venvoy"
LABEL org.opencontainers.image.description="Extremely Portable AI-ready Python and R environment with ultra-fast package managers"
LABEL org.opencontainers.image.url="https://github.com/zaphodbeeblebrox3rd/venvoy"
LABEL org.opencontainers.image.source="https://github.com/zaphodbeeblebrox3rd/venvoy"
LABEL org.opencontainers.image.vendor="zaphodbeeblebrox3rd"
LABEL org.opencontainers.image.licenses="MIT"

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV DEBIAN_FRONTEND=noninteractive
ENV R_VERSION=${R_VERSION}
ENV VENVOY_VERSION=0.1.0
# Note: PIP_NO_CACHE_DIR is not set - we'll use BuildKit cache mounts instead

# Install comprehensive system dependencies for both Python and R
# Use BuildKit cache mount for apt package cache to speed up rebuilds
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y \
    # Build tools
    build-essential \
    gfortran \
    # Version control
    git \
    # Network tools
    curl \
    wget \
    # Text processing
    vim \
    nano \
    htop \
    procps \
    ca-certificates \
    gnupg \
    lsb-release \
    # LaTeX for R Markdown
    texlive-latex-base \
    texlive-latex-recommended \
    texlive-fonts-recommended \
    texlive-latex-extra \
    # Spatial analysis libraries
    libgdal-dev \
    libproj-dev \
    libgeos-dev \
    # Database connectivity
    libpq-dev \
    unixodbc-dev \
    # Image processing
    libmagick++-dev \
    # XML processing
    libxml2-dev \
    # SSL/TLS
    libssl-dev \
    # Compression
    libbz2-dev \
    liblzma-dev \
    # Cairo graphics
    libcairo2-dev \
    # Fonts
    fonts-dejavu-core \
    && apt-get clean

# Install Docker CLI (client only, no daemon) for Remote Containers extension compatibility
# Use BuildKit cache mount for apt package cache
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    chmod a+r /etc/apt/keyrings/docker.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    apt-get install -y docker-ce-cli && \
    apt-get clean

# Install R from Debian CRAN repository
# Note: Debian CRAN repository provides the latest R version for each Debian release
# Version pinning may not be available, so we install the available version
# Use BuildKit cache mount for apt package cache
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && \
    apt-get install -y --no-install-recommends \
    dirmngr \
    gnupg \
    ca-certificates \
    wget \
    lsb-release \
    && mkdir -p /etc/apt/keyrings && \
    wget -q https://cloud.r-project.org/bin/linux/debian/marutter_pubkey.asc -O /tmp/cran_key.asc && \
    gpg --dearmor < /tmp/cran_key.asc > /etc/apt/keyrings/cran.gpg && \
    chmod a+r /etc/apt/keyrings/cran.gpg && \
    rm /tmp/cran_key.asc && \
    DEB_CODENAME=$(lsb_release -cs) && \
    echo "deb [signed-by=/etc/apt/keyrings/cran.gpg] https://cloud.r-project.org/bin/linux/debian ${DEB_CODENAME}-cran40/" > /etc/apt/sources.list.d/cran.list && \
    apt-get update -o Acquire::Check-Valid-Until=false -o Acquire::AllowInsecureRepositories=false 2>&1 | head -20 || true && \
    apt-get install -y --no-install-recommends \
    r-base \
    r-base-core \
    r-base-dev \
    && apt-get clean

# Set up R environment for package installation
RUN R -e "options(repos = c(CRAN = 'https://cran.rstudio.com/')); \
    options(download.file.method = 'libcurl'); \
    options(Ncpus = parallel::detectCores())"

# Install uv for ultra-fast Python package management
# Use BuildKit cache mount for pip cache
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install uv

# Install common AI/ML packages using UV (system-wide installation)
# Use BuildKit cache mount for uv/pip cache
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=cache,target=/root/.cache/pip \
    uv pip install --system \
    numpy \
    pandas \
    matplotlib \
    seaborn \
    jupyter \
    ipython \
    requests \
    python-dotenv \
    scikit-learn \
    rich \
    click \
    fastapi \
    uvicorn

# Create user with flexible UID/GID (will be overridden at runtime)
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN groupadd -g $GROUP_ID venvoy && \
    useradd -u $USER_ID -g $GROUP_ID -m -s /bin/bash venvoy

# Set up workspace
WORKDIR /workspace
RUN chown venvoy:venvoy /workspace

# Create /host-home mount point with proper permissions
RUN mkdir -p /host-home && \
    chmod 755 /host-home

# Create entrypoint script to fix /host-home permissions
RUN echo '#!/bin/bash' > /usr/local/bin/fix-host-home.sh && \
    echo 'set -e' >> /usr/local/bin/fix-host-home.sh && \
    echo '# Fix /host-home permissions if mounted and owned by root' >> /usr/local/bin/fix-host-home.sh && \
    echo 'if [ -d /host-home ] && [ -n "$HOST_UID" ] && [ -n "$HOST_GID" ]; then' >> /usr/local/bin/fix-host-home.sh && \
    echo '    # Check if owned by root' >> /usr/local/bin/fix-host-home.sh && \
    echo '    if [ "$(stat -c %u /host-home 2>/dev/null || echo 0)" = "0" ]; then' >> /usr/local/bin/fix-host-home.sh && \
    echo '        chown -R "$HOST_UID:$HOST_GID" /host-home 2>/dev/null || true' >> /usr/local/bin/fix-host-home.sh && \
    echo '        chmod 755 /host-home 2>/dev/null || true' >> /usr/local/bin/fix-host-home.sh && \
    echo '    fi' >> /usr/local/bin/fix-host-home.sh && \
    echo 'fi' >> /usr/local/bin/fix-host-home.sh && \
    chmod +x /usr/local/bin/fix-host-home.sh

# Switch to user
USER venvoy

# Set up R environment
RUN echo 'options(repos = c(CRAN = "https://cran.rstudio.com/"))' >> ~/.Rprofile && \
    echo 'options(download.file.method = "libcurl")' >> ~/.Rprofile && \
    echo 'options(Ncpus = parallel::detectCores())' >> ~/.Rprofile

# Set up shell with better interactive experience
RUN echo 'export PS1="(ðŸ¤– venvoy) \\u@\\h:\\w\\$ "' >> ~/.bashrc && \
    echo 'echo "ðŸš€ Welcome to your AI-ready venvoy environment!"' >> ~/.bashrc && \
    echo 'echo "ðŸ Python $(python --version) with AI/ML packages"' >> ~/.bashrc && \
    echo 'echo "ðŸ“Š R $(R --version | head -1 | cut -d\" \" -f3) ready for your packages"' >> ~/.bashrc && \
    echo 'echo "ðŸ“¦ Package managers: uv (ultra-fast pip), pip, install.packages() (CRAN)"' >> ~/.bashrc && \
    echo 'echo "ðŸ“Š Pre-installed: numpy, pandas, matplotlib, jupyter, scikit-learn, and more"' >> ~/.bashrc && \
    echo 'echo "ðŸ“‚ Workspace: $(pwd)"' >> ~/.bashrc && \
    echo 'echo "ðŸ’¡ Home directory mounted at: /host-home"' >> ~/.bashrc

# Default command
CMD ["/bin/bash"]

