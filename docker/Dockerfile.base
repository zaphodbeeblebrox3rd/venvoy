# venvoy Base Image - Multi-architecture Python environment
# This image is pre-built and published to Docker Hub
# Usage: docker run --rm -it zaphodbeeblebrox3rd/venvoy:python3.11

ARG PYTHON_VERSION=3.11
FROM python:${PYTHON_VERSION}-slim

# Set labels for the image
LABEL org.opencontainers.image.title="venvoy"
LABEL org.opencontainers.image.description="Extremely Portable AI-ready Python environment with ultra-fast package managers"
LABEL org.opencontainers.image.url="https://github.com/zaphodbeeblebrox3rd/venvoy"
LABEL org.opencontainers.image.source="https://github.com/zaphodbeeblebrox3rd/venvoy"
LABEL org.opencontainers.image.vendor="zaphodbeeblebrox3rd"
LABEL org.opencontainers.image.licenses="MIT"

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV VENVOY_VERSION=0.1.0

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    wget \
    vim \
    nano \
    htop \
    procps \
    ca-certificates \
    gnupg \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# Install Docker CLI (client only, no daemon) for Remote Containers extension compatibility
# This allows Cursor/VSCode Remote Containers to work properly
# Note: The CLI is installed but won't connect to a daemon - this is just to satisfy extension checks
RUN install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg && \
    chmod a+r /etc/apt/keyrings/docker.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    apt-get update && \
    apt-get install -y docker-ce-cli && \
    rm -rf /var/lib/apt/lists/*

# Install miniconda
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-$(uname -m).sh -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh

# Add conda to PATH
ENV PATH="/opt/conda/bin:$PATH"

# Initialize conda with better error handling
RUN /opt/conda/bin/conda --version && \
    (/opt/conda/bin/conda init bash || /opt/conda/bin/conda init || echo "conda init not supported on this platform")

# Update conda first to ensure compatibility
# For older conda versions with SSL issues, temporarily disable SSL verification to update conda
RUN (/opt/conda/bin/conda config --set ssl_verify false 2>/dev/null || true) && \
    (/opt/conda/bin/conda update -n base -c defaults conda -y || \
     /opt/conda/bin/conda update -n base -c conda-forge conda -y || \
     echo "conda update failed, continuing") && \
    (/opt/conda/bin/conda config --set ssl_verify true 2>/dev/null || true)

# Update certifi and openssl to fix SSL issues on older conda versions
# Temporarily disable SSL verification if needed
RUN (/opt/conda/bin/conda config --set ssl_verify false 2>/dev/null || true) && \
    (/opt/conda/bin/conda update -n base -c defaults certifi openssl ca-certificates -y || \
     /opt/conda/bin/conda update -n base -c conda-forge certifi openssl ca-certificates -y || \
     echo "certificate update failed, continuing") && \
    (/opt/conda/bin/conda config --set ssl_verify true 2>/dev/null || true)

# Accept Conda Terms of Service for required channels
RUN /opt/conda/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main 2>/dev/null || echo "ToS acceptance for main channel skipped" && \
    /opt/conda/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r 2>/dev/null || echo "ToS acceptance for r channel skipped"

# Install mamba for faster dependency resolution
# Try conda-forge first, fall back to defaults if that fails
# Temporarily disable SSL verification if needed for older conda versions
RUN (/opt/conda/bin/conda config --set ssl_verify false 2>/dev/null || true) && \
    (/opt/conda/bin/conda install -n base -c conda-forge mamba -y || \
     /opt/conda/bin/conda install -n base -c defaults mamba -y || \
     echo "mamba install failed") && \
    (/opt/conda/bin/conda config --set ssl_verify true 2>/dev/null || true)

# Create venvoy environment using mamba (much faster than conda)
RUN /opt/conda/bin/mamba create -n venvoy python=${PYTHON_VERSION} -c conda-forge -y

# Install uv for ultra-fast Python package management
RUN pip install --no-cache-dir uv

# Activate environment by default
ENV CONDA_DEFAULT_ENV=venvoy
ENV CONDA_PREFIX=/opt/conda/envs/venvoy
ENV PATH="/opt/conda/envs/venvoy/bin:$PATH"

# Install common AI/ML packages using mamba for better dependency resolution
RUN /opt/conda/bin/mamba install -n venvoy -c conda-forge \
    numpy \
    pandas \
    matplotlib \
    seaborn \
    jupyter \
    ipython \
    requests \
    python-dotenv \
    scikit-learn \
    -y

# Install additional fast tools
RUN /opt/conda/envs/venvoy/bin/pip install \
    rich \
    click \
    fastapi \
    uvicorn

# Create user with flexible UID/GID (will be overridden at runtime)
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN groupadd -g $GROUP_ID venvoy && \
    useradd -u $USER_ID -g $GROUP_ID -m -s /bin/bash venvoy

# Set up workspace
WORKDIR /workspace
RUN chown venvoy:venvoy /workspace

# Create /host-home mount point with proper permissions
# This directory will be mounted at runtime, but we need it to exist
# with proper permissions so the mounted volume is accessible
RUN mkdir -p /host-home && \
    chmod 755 /host-home

# Create entrypoint script to fix /host-home permissions
# This script runs as root to fix permissions, then drops to the user
RUN echo '#!/bin/bash' > /usr/local/bin/fix-host-home.sh && \
    echo 'set -e' >> /usr/local/bin/fix-host-home.sh && \
    echo '# Fix /host-home permissions if mounted and owned by root' >> /usr/local/bin/fix-host-home.sh && \
    echo 'if [ -d /host-home ] && [ -n "$HOST_UID" ] && [ -n "$HOST_GID" ]; then' >> /usr/local/bin/fix-host-home.sh && \
    echo '    # Check if owned by root' >> /usr/local/bin/fix-host-home.sh && \
    echo '    if [ "$(stat -c %u /host-home 2>/dev/null || echo 0)" = "0" ]; then' >> /usr/local/bin/fix-host-home.sh && \
    echo '        chown -R "$HOST_UID:$HOST_GID" /host-home 2>/dev/null || true' >> /usr/local/bin/fix-host-home.sh && \
    echo '        chmod 755 /host-home 2>/dev/null || true' >> /usr/local/bin/fix-host-home.sh && \
    echo '    fi' >> /usr/local/bin/fix-host-home.sh && \
    echo 'fi' >> /usr/local/bin/fix-host-home.sh && \
    chmod +x /usr/local/bin/fix-host-home.sh

# Switch to user
USER venvoy

# Set up shell with better interactive experience
RUN echo 'conda activate venvoy' >> ~/.bashrc && \
    echo 'export PS1="(ðŸ¤– venvoy) \\u@\\h:\\w\\$ "' >> ~/.bashrc && \
    echo 'echo "ðŸš€ Welcome to your AI-ready venvoy environment!"' >> ~/.bashrc && \
    echo 'echo "ðŸ Python $(python --version) with AI/ML packages"' >> ~/.bashrc && \
    echo 'echo "ðŸ“¦ Package managers: mamba (fast conda), uv (ultra-fast pip), pip"' >> ~/.bashrc && \
    echo 'echo "ðŸ“Š Pre-installed: numpy, pandas, matplotlib, jupyter, scikit-learn, and more"' >> ~/.bashrc && \
    echo 'echo "ðŸ“‚ Workspace: $(pwd)"' >> ~/.bashrc && \
    echo 'echo "ðŸ’¡ Home directory mounted at: /host-home"' >> ~/.bashrc

# Default command
CMD ["/bin/bash"] 